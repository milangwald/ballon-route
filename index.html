<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Earth Engine ‚Äì Deutschland</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Earth Engine JS API (NEU) -->
  <script src="https://cdn.jsdelivr.net/npm/@google/earthengine@1.7.10/build/ee_api_js.js"></script>

  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 24px; }
    button { padding: 10px 14px; font-size: 16px; cursor: pointer; }
    button[disabled] { opacity: 0.6; cursor: not-allowed; }
    #log { white-space: pre-wrap; background: #f6f6f6; padding: 12px; border-radius: 8px; margin-top: 12px; }
    #map { height: 500px; margin-top: 16px; border-radius: 8px; }
  </style>
</head>

<body>
  <h1>Earth Engine ‚Äì Deutschland</h1>

  <button id="btnLogin">Mit Google anmelden (Popup)</button>
  <div id="log"></div>
  <div id="map"></div>

  <script>
    const CLIENT_ID =
      "695834984820-3aac29g7u9e0rsmsnh4sh5kibmfq3560.apps.googleusercontent.com";
    const SCOPES = ["https://www.googleapis.com/auth/earthengine.readonly"];

    const btn = document.getElementById("btnLogin");
    const logEl = document.getElementById("log");

    function log(m) { console.log(m); logEl.textContent += m + "\n"; }

    let authBusy = false;
    let authFinished = false;

    function setBusy(b) {
      authBusy = b;
      btn.disabled = b;
      btn.textContent = b ? "Login l√§uft ‚Ä¶ (Popup pr√ºfen)" : "Mit Google anmelden (Popup)";
    }

    function showGermanyMap() {
      const map = L.map("map").setView([51.1657, 10.4515], 6);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "¬© OpenStreetMap contributors",
        maxZoom: 19
      }).addTo(map);
      log("üó∫Ô∏è Deutschland-Karte angezeigt.");
    }

    function onAuthSuccess() {
      authFinished = true;
      setBusy(false);
      log("‚úÖ Login erfolgreich. Initialisiere Earth Engine ‚Ä¶");

      ee.initialize(null, null, () => {
        log("‚úÖ Earth Engine bereit.");
        showGermanyMap();

        // Mini-Testcall (optional)
        ee.Number(1).getInfo(
          (v) => log("‚úÖ EE Test OK: " + v),
          (e) => log("‚ùå EE Test Fehler: " + (e?.message || e))
        );
      }, (e) => {
        log("‚ùå ee.initialize() Fehler: " + (e?.message || e));
        console.error(e);
      });
    }

    function onAuthError(err) {
      authFinished = true;
      setBusy(false);
      log("‚ùå Auth-Fehler: " + (err?.message || err));
      console.error(err);
    }

    function onImmediateFailed() {
      authFinished = true;
      setBusy(false);
      log("‚ÑπÔ∏è Silent-Login nicht m√∂glich. Bitte Button klicken.");
    }

    // Popup-Login (nur per User-Klick)
    btn.addEventListener("click", () => {
      if (authBusy) return;
      setBusy(true);
      log("‚û°Ô∏è Popup-Login startet ‚Ä¶");

      // Laut Doku: authenticateViaPopup(success, error)
      ee.data.authenticateViaPopup(onAuthSuccess, onAuthError); // :contentReference[oaicite:4]{index=4}
    });

    // Start: Silent-Auth versuchen (Bonus)
    log("‚úÖ Script gestartet");
    log("ee vorhanden? " + typeof ee);
    log("‚û°Ô∏è Starte authenticateViaOauth() (silent Versuch) ‚Ä¶");

    try {
      ee.data.authenticateViaOauth(
        CLIENT_ID,
        onAuthSuccess,
        onAuthError,
        SCOPES,
        onImmediateFailed,
        true
      ); // :contentReference[oaicite:5]{index=5}
    } catch (e) {
      log("‚ùå Exception bei authenticateViaOauth(): " + e);
      console.error(e);
    }

    // Falls Silent h√§ngt: Button bleibt nutzbar
    setTimeout(() => {
      if (!authFinished) {
        setBusy(false);
        log("‚ÑπÔ∏è Silent-Login h√§ngt/blockiert. Popup benutzen.");
      }
    }, 2000);
  </script>
</body>
</html>
